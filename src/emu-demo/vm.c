//
// Created by SuHaitao on 2022/12/22.
//

#include "emu.h"

#include <string.h>
#include <stdio.h>
#include <synchapi.h>

struct pkt_data {
    const char *name;
    long len;
    const char *data;
};

struct pkt_data dhcp[] = {
        {
            "DHCP Release", 342,
            "\x6e\x44\xd5\x19\xee\xcc\x52\x54\x00\x12\x34\x56\x08\x00\x45\x00" \
            "\x01\x48\x61\x04\x40\x00\x40\x11\x02\x43\xc0\xa8\x2a\x8c\xc0\xa8" \
            "\x2a\x81\x00\x44\x00\x43\x01\x34\x24\x37\x01\x01\x06\x00\xe6\x01" \
            "\xb2\x61\x00\x00\x00\x00\xc0\xa8\x2a\x8c\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x52\x54\x00\x12\x34\x56\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x63\x82\x53\x63\x35\x01\x07\x36\x04\xc0" \
            "\xa8\x2a\x81\x0c\x20\x73\x68\x74\x2d\x53\x74\x61\x6e\x64\x61\x72" \
            "\x64\x2d\x50\x43\x2d\x69\x34\x34\x30\x46\x58\x2d\x50\x49\x49\x58" \
            "\x2d\x31\x39\x39\x36\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00"

        },
        {
            "DHCP Discover", 342,
            "\xff\xff\xff\xff\xff\xff\x52\x54\x00\x12\x34\x56\x08\x00\x45\x10" \
            "\x01\x48\x00\x00\x00\x00\x80\x11\x39\x96\x00\x00\x00\x00\xff\xff" \
            "\xff\xff\x00\x44\x00\x43\x01\x34\x8f\x3c\x01\x01\x06\x00\x52\xae" \
            "\xb2\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x52\x54\x00\x12\x34\x56\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x63\x82\x53\x63\x35\x01\x01\x32\x04\xc0" \
            "\xa8\x2a\x8c\x0c\x20\x73\x68\x74\x2d\x53\x74\x61\x6e\x64\x61\x72" \
            "\x64\x2d\x50\x43\x2d\x69\x34\x34\x30\x46\x58\x2d\x50\x49\x49\x58" \
            "\x2d\x31\x39\x39\x36\x37\x0d\x01\x1c\x02\x03\x0f\x06\x77\x0c\x2c" \
            "\x2f\x1a\x79\x2a\xff\x00"
        },
        {
            "DHCP Request", 347,
            "\xff\xff\xff\xff\xff\xff\x52\x54\x00\x12\x34\x56\x08\x00\x45\x10" \
            "\x01\x4d\x00\x00\x00\x00\x80\x11\x39\x91\x00\x00\x00\x00\xff\xff" \
            "\xff\xff\x00\x44\x00\x43\x01\x39\x5f\x11\x01\x01\x06\x00\x52\xae" \
            "\xb2\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x52\x54\x00\x12\x34\x56\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
            "\x00\x00\x00\x00\x00\x00\x63\x82\x53\x63\x35\x01\x03\x36\x04\xc0" \
            "\xa8\x2a\x81\x32\x04\xc0\xa8\x2a\x8c\x0c\x20\x73\x68\x74\x2d\x53" \
            "\x74\x61\x6e\x64\x61\x72\x64\x2d\x50\x43\x2d\x69\x34\x34\x30\x46" \
            "\x58\x2d\x50\x49\x49\x58\x2d\x31\x39\x39\x36\x37\x0d\x01\x1c\x02" \
            "\x03\x0f\x06\x77\x0c\x2c\x2f\x1a\x79\x2a\xff"
        }
};

struct pkt_data tcp[] = {
        {
            "TCP SYN", 74,
            "\x6e\x44\xd5\x19\xee\xcc\x52\x54\x00\x12\x34\x56\x08\x00\x45\x00" \
            "\x00\x3c\x73\xb5\x40\x00\x40\x06\x28\x9e\xc0\xa8\x2a\x8c\x6e\xf2" \
            "\x44\x42\x83\x16\x00\x50\xc2\xb1\xe1\x27\x00\x00\x00\x00\xa0\x02" \
            "\xfa\xf0\x07\x02\x00\x00\x02\x04\x05\xb4\x04\x02\x08\x0a\xdb\x33" \
            "\xa5\x30\x00\x00\x00\x00\x01\x03\x03\x07"
        },
        {
            "TCP ACK", 60,
            "\x6e\x44\xd5\x19\xee\xcc\x52\x54\x00\x12\x34\x56\x08\x00\x45\x00" \
            "\x00\x28\x73\xb6\x40\x00\x40\x06\x28\xb1\xc0\xa8\x2a\x8c\x6e\xf2" \
            "\x44\x42\x83\x16\x00\x50\xc2\xb1\xe1\x28\x1a\x71\xc3\xc1\x50\x10" \
            "\x01\xf6\x0a\x02\x00\x00\x00\x00\x00\x00\x00\x00"
        }
};

void send_packets_set(struct pkt_data *packets, size_t len) {
    for (int i = 0; i < len; ++i) {
        nic_buffer_len = packets[i].len;
        memcpy(nic_buffer, packets[i].data, nic_buffer_len);
        if (vm_exit(VM_TX_INTR) == packets[i].len) {
            printf("Written %s %ld bytes\n", packets[i].name, packets[i].len);
        } else {
            printf("Failed to write %s\n", packets[i].name);
        }
        Sleep(1000);
    }
}

#define ARRAY_LEN(name, type) (sizeof(name) / sizeof(type))

void vm_start()
{
    send_packets_set(dhcp, ARRAY_LEN(dhcp, struct pkt_data));
    send_packets_set(tcp, ARRAY_LEN(tcp, struct pkt_data));
    vm_exit(VM_STOP);
}